# Konductor dev container with IDE tools baked in
#
# Build: docker build -f Dockerfile.dev -t ghcr.io/braincraftio/konductor:dev .
# Run:   docker run --rm -it ghcr.io/braincraftio/konductor:dev
# Admin: docker run --rm -it -u kc2admin ghcr.io/braincraftio/konductor:dev

ARG BASE_TAG=latest
FROM ghcr.io/braincraftio/konductor:${BASE_TAG} AS base

# Install dev environment using nix develop
USER kc2admin
RUN sudo nix develop konductor#dev --profile /nix/var/nix/profiles/dev -c true && \
    sudo nix-env --set /nix/var/nix/profiles/dev

# Validate IDE tools (from idePackages)
RUN lazygit --version && \
    htop --version && \
    btm --version && \
    bat --version && \
    eza --version && \
    dust --version && \
    tree --version

# Validate neovim and tmux
RUN nvim --version && \
    tmux -V

# Validate tools still work
RUN git --version && \
    claude --version

# Test stage for user validation
FROM base AS test

# Validate kc2 permissions
USER kc2
RUN touch /home/kc2/test && rm /home/kc2/test

# Validate kc2admin permissions
USER kc2admin
RUN touch /home/kc2admin/test && rm /home/kc2admin/test && \
    groups | grep -q kc2 && \
    (sudo whoami | grep -q root || true)

# Final production image
FROM base AS production

# Workspace directory setup
USER root
RUN mkdir -p /workspace && \
    chown 1000:1000 /workspace && \
    chmod 2775 /workspace

# Unprivileged kc2 user
USER kc2

# Working directory
WORKDIR /workspace

# Default entrypoint
ENTRYPOINT ["/bin/bash"]
CMD ["-l"]
